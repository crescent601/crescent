{% extends 'base.html' %}
{% load static %} {# Make sure this is present if you use static files #}

{% block content %}
<div class="container mt-4">
    <h2>{{ product_training.title }} Videos</h2>

    {% if messages %}
        <div class="messages">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="row">
        {% for video in videos %}
        <div class="col-md-6 mb-4">
            <div class="card video-card" id="video-card-{{ video.id }}">
                <div class="card-body">
                    <h5 class="card-title">{{ forloop.counter }}. {{ video.title|default:"Untitled Video" }}</h5>
                    
                    {# This is the container for the YouTube player #}
                    {# The style here acts as a fallback/initial visual lock #}
                    <div class="video-player-container" 
                         id="youtube-player-{{ video.id }}" 
                         data-youtube-id="{{ video.get_youtube_video_id }}"
                         {# Initial inline style for locked videos - JavaScript will fine-tune #}
                         {% if video.id not in unlocked_video_ids %}style="filter: grayscale(100%); pointer-events: none;"{% endif %}>
                        {% if video.id not in unlocked_video_ids %}
                            {# Overlay for locked videos #}
                            <div class="locked-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; color: white; font-size: 1.5rem; text-align: center; cursor: not-allowed; z-index: 10;">
                                <i class="fas fa-lock me-2"></i> Locked - Complete previous quiz
                            </div>
                        {% endif %}
                    </div>

                    <div class="quiz-section mt-3">
                        {% if video.questions.exists %}
                            {% with quiz_result=result_map|get_item:video.id %}
                                {% if quiz_result and quiz_result.completed %}
                                    <p>Quiz Status: 
                                        {% if quiz_result.passed %}
                                            <span style="color: green; font-weight: bold;">Passed!</span> (Score: {{ quiz_result.score }}%)
                                        {% else %}
                                            <span style="color: red; font-weight: bold;">Failed.</span> (Score: {{ quiz_result.score }}%) - Please try again.
                                        {% endif %}
                                    </p>
                                    {# If failed, show retake button #}
                                    {% if not quiz_result.passed and video.id in unlocked_video_ids %}
                                        <button class="btn btn-warning btn-sm take-quiz-btn" data-video-id="{{ video.id }}">Retake Quiz</button>
                                    {% endif %}
                                {% else %}
                                    {# Quiz not completed, if video is unlocked, show 'Take Quiz' button #}
                                    {% if video.id in unlocked_video_ids %}
                                        <button class="btn btn-primary btn-sm take-quiz-btn" data-video-id="{{ video.id }}">Take Quiz</button>
                                    {% else %}
                                        <p class="text-muted">Complete previous videos to attempt quiz.</p>
                                    {% endif %}
                                {% endif %}
                            {% endwith %}
                        {% else %}
                            <p class="text-info">No quiz available for this video.</p>
                        {% endif %}
                    </div>

                    {# Quiz Form (initially hidden by CSS/JS) #}
                    {% if video.questions.exists %}
                    <form id="quiz-form-{{ video.id }}" class="quiz-form mt-4" action="{% url 'submit_quiz' video.id %}" method="post" style="display: none;">
                        {% csrf_token %}
                        {% for question in video.questions.all %}
                            <div class="question-block mb-3">
                                <p><strong>{{ forloop.counter }}. {{ question.question_text }}</strong></p>
                                {% for answer in question.answers.all %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="question_{{ question.id }}" id="answer_{{ answer.id }}" value="{{ answer.id }}" required>
                                        <label class="form-check-label" for="answer_{{ answer.id }}">
                                            {{ answer.answer_text }}
                                        </label>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endfor %}
                        <button type="submit" class="btn btn-success mt-3">Submit Quiz</button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

{# Hidden script tags to pass data to JavaScript #}
<script id="unlocked-video-ids-data" type="application/json">
    {{ unlocked_video_ids|json_script:"unlocked-video-ids-data" }}
</script>
<script id="result-map-data" type="application/json">
    {{ result_map|json_script:"result-map-data" }}
</script>

{% endblock %}

{% block extra_js %}
{# Load the YouTube Iframe API script (if not already in base.html) #}
{# It's recommended to load this once in base.html if used across multiple pages #}
{# If it's already in base.html or a global script, you can remove this line here. #}
<script async src="https://www.youtube.com/iframe_api"></script>
<script src="{% static 'js/product_videos.js' %}"></script>
{% endblock %}